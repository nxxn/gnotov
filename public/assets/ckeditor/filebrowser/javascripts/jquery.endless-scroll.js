/**
 * Author: Sergey Kukunin
 * See: https://github.com/Kukunin/jquery-endless-scroll
 */
(function(e){"use strict";e.support.pushState=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/);var t={init:function(t,n){n.options=e.extend({scrollContainer:window,scrollPadding:100,scrollEventDelay:300},t),this.options=n.options,this.container=n.container,n.scrollModule=this,this._toplock=!0,this._bottomlock=!0,this.scrollContainer=e(this.options.scrollContainer),this.updateEntities(),this.sortMarkers(),this.currentPage=null,this.container.on("jes:afterPageLoad",e.proxy(function(e,t,n){this.updateEntities(),this.sortMarkers(),this.checkMarker();if(n=="top"){var r=this.markers[1].top,i=this.scrollContainer.scrollTop();this.scrollContainer.scrollTop(i+r)}},this)),this.bind()},updateEntities:function(){this.entities=e(this.options.entity,this.container)},sortMarkers:function(){var t=[];e(".jes-marker",this.container).each(function(){t.push({top:e(this).position().top,url:e(this).data("jesUrl")})}),this.markers=t},checkMarker:function(){var t=this.markers[0],n=this.scrollContainer.scrollTop();for(var r=1;r<this.markers.length;r++){if(!(n>this.markers[r].top))break;t=this.markers[r]}t.url!=this.currentPage&&(this.currentPage=t.url,e(this.container).trigger("jes:scrollToPage",t.url))},bind:function(){this.scrollContainer.on("scroll.jes",e.proxy(function(t){if(this._tId)return;this.scrollHandler(t),this._tId=setTimeout(e.proxy(function(){this._tId=null},this),this.options.scrollEventDelay)},this))},unbind:function(){e(this.options.scrollContainer).off("scroll.jes")},scrollHandler:function(t){var n=this.scrollContainer,r=this.entities,i=r.first(),s=r.last(),o=n.scrollTop(),u=n.height(),a=o+u,f=i.position().top,l=f+this.options.scrollPadding,c=s.outerHeight()+s.position().top,h=c-this.options.scrollPadding;o<l?this._toplock||(e(this.container).trigger("jes:topThreshold"),this._toplock=!0):this._toplock=!1,a>h?this._bottomlock||(e(this.container).trigger("jes:bottomThreshold"),this._bottomlock=!0):this._bottomlock=!1,this.checkMarker()}},n={init:function(t,n){n.options=e.extend({},t),this.options=n.options,this.container=n.container,this.setMarker(e(this.options.entity,this.container).first(),location.href),n.ajaxModule=this},loadPage:function(t,n,r){var i={top:{find:"first",inject:"insertBefore"},bottom:{find:"last",inject:"insertAfter"}},s=i[n];this.container.trigger("jes:beforePageLoad",[t,n]),e.get(t,null,e.proxy(function(i){var o=e("<div>").html(i),u=this.options.container,a=e(u,o).first();if(a.length){var f=a.find(this.options.entity);n=="bottom"&&f.each(function(t){var n=e(this).attr("id");n&&e("#"+n,this.container).remove()});var l=e(this.options.entity,u)[s.find]();f[s.inject](l),this.setMarker(f.first(),t)}e.isFunction(r)&&r(o),this.container.trigger("jes:afterPageLoad",[t,n,o,f])},this),"html")},setMarker:function(e,t){e.addClass("jes-marker").data("jesUrl",t)}},r={init:function(t,n){n.options=e.extend({nextPage:".pagination a[rel=next]",previousPage:".pagination a[rel=previous]"},t),this.options=n.options,this.container=n.container,e.each([{selector:this.options.nextPage,event:"jes:bottomThreshold.navigation",placement:"bottom"},{selector:this.options.previousPage,event:"jes:topThreshold.navigation",placement:"top"}],e.proxy(function(t,r){r.element=e(r.selector);if(r.element.length){var i=r.element.prop("href"),s=!1,o=function(){if(s||!i)return;s=!0,n.ajaxModule.loadPage(i,r.placement,e.proxy(function(t){var n=e(r.selector,e(t));n.length?(s=!1,i=n.prop("href"),r.element.attr("href",i)):(e(this).off(r.event),r.element.remove())},this))};e(this.container).on(r.event,o),e(r.element).on("click",e.proxy(function(e){e.preventDefault(),o.apply(this.container)},this))}},this))}},i={init:function(t,n){if(!e.support.pushState)return;n.container.on("jes:scrollToPage",function(e,t){history.replaceState({},null,t)})}};e.endlessScroll=function(s){this.options=e.extend(!0,{container:"#container",entity:".entity",_modules:[n,t,r,i],modules:[]},s),this.container=e(this.options.container);if(!this.container.length)throw"Container for endless scroll isn't available on the page";return e.merge(this.options.modules,this.options._modules),this.options.modules.forEach(e.proxy(function(e){e.init(this.options,this)},this)),this}})(jQuery);